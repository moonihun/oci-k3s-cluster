#cloud-config

bootcmd:
  - [ cloud-init-per, once, growpart, growpart, /dev/sda, "3" ]
  - [ cloud-init-per, once, pvresize, pvresize, /dev/sda3 ]
  - [ cloud-init-per, once, lvextend, lvextend, -l, +100%FREE, /dev/mapper/ocivolume-root ]
  - [ cloud-init-per, once, xfs_growfs, xfs_growfs, / ]

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - nfs-utils

write_files:
  # SSH Private Key
  - path: /home/opc/.ssh/id_ed25519_oci
    permissions: '0600'
    content: |
      ${ssh_private_key}

  - path: /usr/local/bin/get-k3s-ips.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Public IP
      PUBLIC_IP=${master_public_ip}

      # Private IP
      PRIVATE_IP=$(hostname -I | awk '{print $1}')

      echo "PUBLIC_IP=$PUBLIC_IP"
      echo "PRIVATE_IP=$PRIVATE_IP"

  - path: /etc/rancher/k3s/config.yaml
    permissions: '0644'
    content: |
      token: ${k3s_token}
      cluster-init: true
      disable:
        - traefik
      flannel-backend: none
      disable-network-policy: true
      write-kubeconfig-mode: "0644"

runcmd:
  - chown opc:opc /home/opc/.ssh/id_ed25519_oci
  - chmod 600 /home/opc/.ssh/id_ed25519_oci

  # firewalld 비활성화
  - systemctl disable --now firewalld

  # iptables 초기화
  - iptables -F && iptables -X
  - iptables -t nat -F && iptables -t nat -X

  # NFS 설정
  - mkdir -p /nfs/storage && chmod 777 /nfs/storage
  - echo "/nfs/storage 10.0.0.0/16(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
  - systemctl enable --now nfs-server
  - exportfs -ra

  # K3S config 디렉터리 생성 및 설정 파일 준비
  - mkdir -p /etc/rancher/k3s
  - |
    bash -c 'cat > /etc/rancher/k3s/config.yaml <<EOF
    token: ${k3s_token}
    cluster-init: true
    disable:
      - traefik
    flannel-backend: none
    disable-network-policy: true
    write-kubeconfig-mode: "0644"
    tls-san:
      - $(hostname -I | awk "{print \$1}")
      - ${master_public_ip}
    EOF'

  # K3S 설치
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --cluster-init" sh -s -

  # K3S 시작 대기
  - for i in {1..60}; do systemctl is-active --quiet k3s && break || sleep 2; done

  # Kubeconfig 복사
  - mkdir -p /home/opc/.kube && cp /etc/rancher/k3s/k3s.yaml /home/opc/.kube/config && chown -R opc:opc /home/opc/.kube /home/opc/.ssh && chmod 600 /home/opc/.kube/config

  # kubectl alias
  - echo "alias k=kubectl" >> /home/opc/.bashrc && echo "export KUBECONFIG=/home/opc/.kube/config" >> /home/opc/.bashrc

final_message: "K3S Master installation completed after $UPTIME seconds"

